var e,t;"function"==typeof(e=globalThis.define)&&(t=e,e=null),function(t,r,o,n,i){var s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},a="function"==typeof s[n]&&s[n],l=a.cache||{},c="undefined"!=typeof module&&"function"==typeof module.require&&module.require.bind(module);function u(e,r){if(!l[e]){if(!t[e]){var o="function"==typeof s[n]&&s[n];if(!r&&o)return o(e,!0);if(a)return a(e,!0);if(c&&"string"==typeof e)return c(e);var i=Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}f.resolve=function(r){var o=t[e][1][r];return null!=o?o:r},f.cache={};var p=l[e]=new u.Module(e);t[e][0].call(p.exports,f,p,p.exports,this)}return l[e].exports;function f(e){var t=f.resolve(e);return!1===t?{}:u(t)}}u.isParcelRequire=!0,u.Module=function(e){this.id=e,this.bundle=u,this.exports={}},u.modules=t,u.cache=l,u.parent=a,u.register=function(e,r){t[e]=[function(e,t){t.exports=r},{}]},Object.defineProperty(u,"root",{get:function(){return s[n]}}),s[n]=u;for(var p=0;p<r.length;p++)u(r[p]);if(o){var f=u(o);"object"==typeof exports&&"undefined"!=typeof module?module.exports=f:"function"==typeof e&&e.amd?e(function(){return f}):i&&(this[i]=f)}}({kRC5D:[function(e,t,r){var o=e("@parcel/transformer-js/src/esmodule-helpers.js");o.defineInteropFlag(r),o.export(r,"googleDriveService",()=>a);var n=e("./supabase/auth-service"),i=e("./error-handlers"),s=e("../services/permissions");let a=new class{async getValidToken(){try{let e=(0,n.authService).getGoogleToken();if(!e)try{e=await (0,n.authService).refreshGoogleToken()}catch(t){let e=(0,i.logExtensionError)(t,"Google token refresh via authService");return e.type,null}return e}catch(e){return(0,i.logExtensionError)(e,"Google Drive token retrieval via authService",{operation:"getValidToken"}),null}}async createTableXportFolder(){let e=await this.getValidToken();if(!e)return null;try{let t=await fetch(`${this.baseUrl}/files?q=name='TableXport' and mimeType='application/vnd.google-apps.folder' and trashed=false`,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw Error(`Search failed: ${t.status} ${t.statusText}`);let r=await t.json();if(r.files&&r.files.length>0)return r.files[0].id;let o=await fetch(`${this.baseUrl}/files`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:"TableXport",mimeType:"application/vnd.google-apps.folder"})});if(!o.ok)throw Error(`Folder creation failed: ${o.status} ${o.statusText}`);let n=await o.json();return n.id}catch(e){return(0,i.logExtensionError)(e,"Google Drive folder creation"),null}}async uploadFile(e){let t=await (0,s.ensureGoogleApisHostPermissions)();if(!t)return{success:!1,error:"\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044f \u0440\u0430\u0437\u0440\u0435\u0448\u0435\u043d\u0438\u0435 \u043d\u0430 \u0434\u043e\u0441\u0442\u0443\u043f \u043a Google API (optional host permissions \u043d\u0435 \u0432\u044b\u0434\u0430\u043d\u044b)"};let r=await this.getValidToken();if(!r)return{success:!1,error:"Google authentication required. Please reconnect your Google Drive account."};let o=0;try{let t,n;let s=e.folderId||await this.createTableXportFolder(),a={name:e.filename,parents:s?[s]:void 0},l="-------314159265358979323846",c=`\r
--${l}\r
`,u=`\r
--${l}--`,p=e.mimeType;if("string"==typeof e.content)o=(t=e.content).length;else{let r=e.content;o=r.size,t=await r.arrayBuffer()}if("string"==typeof t)n=c+"Content-Type: application/json\r\n\r\n"+JSON.stringify(a)+c+`Content-Type: ${p}\r
\r
`+t+u;else{let e=new TextEncoder,r=c+"Content-Type: application/json\r\n\r\n"+JSON.stringify(a)+c+`Content-Type: ${p}\r
\r
`,o=e.encode(r),i=e.encode(u),s=new Uint8Array(t),l=o.length+s.length+i.length;n=new Uint8Array(l);let f=0;n.set(o,f),f+=o.length,n.set(s,f),f+=s.length,n.set(i,f)}let f=await fetch(`${this.uploadUrl}?uploadType=multipart`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":`multipart/related; boundary="${l}"`},body:n});if(!f.ok){let t=await f.text(),r=Error(`Upload failed: ${f.status} ${f.statusText} - ${t}`);throw(0,i.logExtensionError)(r,"Google Drive file upload",{filename:e.filename,responseStatus:f.status,responseStatusText:f.statusText,errorText:t,originalSize:o,uploadSize:"string"==typeof n?n.length:n.byteLength}),r}let d=await f.json(),h=d.webViewLink||`https://drive.google.com/file/d/${d.id}/view`;return{success:!0,fileId:d.id,webViewLink:h}}catch(r){let t=(0,i.logExtensionError)(r,"Google Drive file upload",{filename:e.filename,mimeType:e.mimeType,originalSize:o});return{success:!1,error:t.userAction||t.message}}}async exportTable(e,t,r){let o,n,i;switch(r){case"csv":o="\uFEFF"+this.convertToCSV(e),n="text/csv",i=".csv";break;case"xlsx":o=this.convertToCSV(e),n="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",i=".xlsx";break;case"docx":o=this.convertToCSV(e),n="application/vnd.openxmlformats-officedocument.wordprocessingml.document",i=".docx";break;case"pdf":o=this.convertToCSV(e),n="application/pdf",i=".pdf";break;default:return{success:!1,error:`Unsupported format: ${r}`}}let s=t.endsWith(i)?t:`${t}${i}`;return this.uploadFile({filename:s,content:o,mimeType:n})}convertToCSV(e){return e.map(e=>e.map(e=>{let t=String(e||"");return t.includes('"')||t.includes(",")||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t}).join(",")).join("\n")}constructor(){this.baseUrl="https://www.googleapis.com/drive/v3",this.uploadUrl="https://www.googleapis.com/upload/drive/v3/files"}}},{"./supabase/auth-service":"eQfzB","./error-handlers":"GrmBg","../services/permissions":"4FEi3","@parcel/transformer-js/src/esmodule-helpers.js":"fRZO2"}],"4FEi3":[function(e,t,r){var o=e("@parcel/transformer-js/src/esmodule-helpers.js");o.defineInteropFlag(r),o.export(r,"hasGoogleApisHostPermissions",()=>i),o.export(r,"requestGoogleApisHostPermissions",()=>s),o.export(r,"ensureGoogleApisHostPermissions",()=>a);let n=["https://www.googleapis.com/*","https://sheets.googleapis.com/*"];async function i(){return new Promise(e=>{if(!chrome?.permissions)return e(!1);chrome.permissions.contains({origins:n},t=>e(!!t))})}async function s(){return new Promise(e=>{if(!chrome?.permissions)return e(!1);chrome.permissions.request({origins:n},t=>e(!!t))})}async function a(){let e=await i();return!!e||await s()}},{"@parcel/transformer-js/src/esmodule-helpers.js":"fRZO2"}]},[],null,"parcelRequire709e"),globalThis.define=t;